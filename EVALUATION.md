# Encrypted File Detection via the Chi-Square Test

## Outline
The goal of this program is to determine if a specified file is encrypted or not. Encrypted files contain more random bytes than raw or compressed files. For the purpose of this program, randomess is measured using the [chi-square test](http://en.wikipedia.org/wiki/Chi-square_test).

If the bytes composing a file are completely random, the expected incidence rate of `0x00` can be calculated using the formula `(total bytes)/256` (256 is used because byte values may be between 0 and 255). If the bytes are not random, the rate will vary considerably.

![](http://upload.wikimedia.org/math/1/9/a/19a61a6c2844c76004d17666674c31df.png)

If χ^2 (chi-squared) is larger than a certain value, it suggests that the file is not random or encrypted. χ^2 has its own unique [distribution profile](http://en.wikipedia.org/wiki/Chi-squared_distribution) and has the following associated probability density function:

![](http://www.philender.com/courses/intro/notes3/xdist.gif)

The probability that `x^2` value is larger than the `(x^2)*` in figure above is indicated by the blue area. This probability is called the 'significance level'. 

If the `x^2` distribution is not equal to one in the above figure, it may indicate the data in question is not random. When the `x^2` value is bigger than `(x^2)*`, the probability that the data is, in fact, random is indicated by (and equals) the blue area.

A significance level of 5% is commonly accepted as reasonable for this test. However, this may mean that the false negative rate (i.e. a file is falsely determined to be unencrypted) is 5%.

The distribution in the figure will vary depending on the number of the summation. This number is called "degrees of freedom `(k)`." In our case, `k = 256 - 1 = 255`. When `k = 255` and the significance level is 5%, `(x^2)* = 293.247835`. Further details regarding this calculation are available [here](https://www.sist.ac.jp/~suganuma/cpp/2-bu/7-sho/C++/chi.txt).

## Methods
This program can analyze a file in its entirety, or by chunks:

### Whole-File Analysis

With whole-file analysis, the chi-square deviation is calculated for the whole file. The resulting deviation is used to determine if the specified file is encrypted or not. A 5% significance level is used for this determination:

   (1) Calculate the histogram for data `0x00 ~ 0xff` (i.e. count the number of bytes).
   (2) Calculate ![](http://upload.wikimedia.org/math/1/9/a/19a61a6c2844c76004d17666674c31df.png), where `observed` is the number determined in step (1) and `expected` is `(total bytes)/256).
   (3) If `x^2 < 293.247835`, the file is determined to be encrypted.

### Discrete Chunk Analysis

Discrete chunk analysis calculates the chi-square deviation for each chunk of 32 bytes in the file. A tolerance deviation of < 512 was used for detecting suspicious chunks. If the number of suspicious chunks is greater than five, the file is determined to be unencrypted.

These parameters were also derived (apparently in a heuristic fashion) from the [aforementioned paper](https://www.sist.ac.jp/~suganuma/cpp/2-bu/7-sho/C++/chi.txt).

The exact steps are as follows:

    (1) Set the pointer at the start of the file data.
    (2) Calculate `x^2` for 32 bytes from pointer.
    (3) If `x^2 > 512`, increment the number of suspecious chunks counter by one.
    (4) Move the pointer forward by 32 bytes.
    (5) Repeat steps (3) and (4) until you reach the end of the file.
    (6) IF the number of suspicious chunks is greater than or equal to 5, the file is determined to be unencrypted.

## Evaluation

1. [FourmiLab](http://www.fourmilab.ch/random/) was used to test files generated by Storj's [RandomIO library](https://github.com/Storj/RandomIO). The chi-square distributions were checked and the results matched those of Chizer (this program). 

```
$ ./ent data/1f567965f3b034d819d035cbfa68f4b1 
Entropy = 7.999658 bits per byte.

Optimum compression would reduce the size
of this 500000 byte file by 0 percent.

Chi square distribution for 500000 samples is 237.05, and randomly
would exceed this value 78.36 percent of the times.

Arithmetic mean value of data bytes is 127.5081 (127.5 = random).
Monte Carlo value for Pi is 3.148812595 (error 0.23 percent).
Serial correlation coefficient is -0.001882 (totally uncorrelated = 0.0).
```
* data/1f567965f3b034d819d035cbfa68f4b1(500,000bytes):237.053952
* data/d0d5aadd2e49c38f52261d9b5a3e6d9a(1,00,000bytes):223.445504
* data/5167585a6f04f84378734a59249fc741 (3,000,000bytes):267.375104
* data/bbd39238d1e5368c95ade4554dae9712(5,000,000bytes):275.085312
* data/578419af524bc10e35a4aa27fee31b1b(10,000,000bytes):232.634829

2. Chizer was run against the files listed above and all files were determined to be encrypted.

```
$ ./chizer data/1f567965f3b034d819d035cbfa68f4b1 
        Chi square distribution=237.053952
;-)     Whole File is encrypted.
        suspecious blocks:0
;-)     chunks are encrypted.
```

3. When analyzing the [Storj Promotion Video](https://www.youtube.com/watch?v=vl3bUzfn2lg), Chizer correctly determined it was unencrypted:

```
$../chizer data/Storj\ -\ Decentralizing\ Cloud\ Storage-vl3bUzfn2lg.mp4
        Chi square distribution=231780.126855
:-(     Whole File is NOT encrypted.
        suspecious blocks:3594
:-(     chunks are NOT encrypted.

```

4. When the file from (3) was gzipped and reanalyzed, it was again correctly determined to be unencrypted:

```
$ ./chizer data/Storj\ -\ Decentralizing\ Cloud\ Storage-vl3bUzfn2lg.mp4.gz 
        Chi square distribution=3035.437162
:-(     Whole File is NOT encrypted.
        suspecious blocks:183
:-(     chunks are NOT encrypted.
```

5. When the file from (3) was bzipped and reanalyzed, it was also correctly determined to be unencrypted.
```
$ ./chizer data/Storj\ -\ Decentralizing\ Cloud\ Storage-vl3bUzfn2lg.mp4.bz2 
        Chi square distribution=1809.816191
:-(     Whole File is NOT encrypted.
        suspecious blocks:134
:-(     chunks are NOT encrypted.
```

6. When appending a gzaipped version of the MP3 audio from the promotional video to 30 MB of data generated by `RandomIO`, the resulting data conglomeration was correctly determined to be unencrypted. In other words, an unencrypted payload was not able to "sneak by" detection in this case:

```
$  ./chizer data/ac59ab5a282afd3de22062c7d62b5367 
        Chi square distribution=236.723524
;-)     Whole File is encrypted.
        suspecious blocks:0
;-)     chunks are encrypted.

$ ./chizer data/Storj\ -\ Decentralizing\ Cloud\ Storage-vl3bUzfn2lg.mp3.gz 
        Chi square distribution=2018.514713
:-(     Whole File is NOT encrypted.
        suspecious blocks:6
:-(     chunks are NOT encrypted.

$ cat RandomIO/ac59ab5a282afd3de22062c7d62b5367 data/Storj\ -\ Decentralizing\ Cloud\ Storage-vl3bUzfn2lg.mp3.gz >> mixed2.dat

$ ./chizer  mixed2.dat 
        Chi square distribution=261.202954
;-)     Whole File is encrypted.
        suspecious blocks:6
:-(     chunks are NOT encrypted.
```

The graph of the chi-square distribution is:

![](http://i.imgur.com/G7hWfKu.png)

(`x`: chuck no from beginng of file, `y`: distribution)

7. When gzipping and analyzing an encrypted file, Chizer indicates that the file is encrypted.
```
$./chizer data.gz/1f567965f3b034d819d035cbfa68f4b1.gz 
        Chi square distribution=235.491691
;-)     Whole File is encrypted.
        suspecious blocks:0
;-)     chunks are encrypted.

```

## Performance

Using the following test environment...

    * Compiler: gcc -o chizer chizer.c -O3
    * Kernel: Linux  3.18.4-1-ARCH #1 SMP PREEMPT Tue Jan 27 20:45:02 CET 2015 x86_64 GNU/Linux
    * CPU: AMD Athlon(tm) 64 X2 Dual Core Processor 3800+
    * Memory: 3 GB

...a 30 MB data shard can be tested in approximately 0.8 seconds:

```
$ time ./chizer data/ac59ab5a282afd3de22062c7d62b5367
;-)     Whole File is encrypted.
;-)     chunks are encrypted.

real    0m0.863s
user    0m0.767s
sys     0m0.043s
```

time of  whole file test vs chunks test

```
$ time ./chizer data/ac59ab5a282afd3de22062c7d62b5367
;-)     Whole File is encrypted.

real    0m0.145s
user    0m0.100s
sys     0m0.027s
$ time ./chizer data/ac59ab5a282afd3de22062c7d62b5367
;-)     chunks are encrypted.

real    0m0.738s
user    0m0.693s
sys     0m0.007s
```

result on travis:
```
$ time ./chizer data/ac59ab5a282afd3de22062c7d62b5367
;-) Whole File is encrypted.
;-) chunks are encrypted.

real 0m0.662s
user 0m0.631s
sys 0m0.030s
```

## References
1. Differentiate Encryption From Compression Using Math - /dev/ttyS0. 2015. Differentiate Encryption From Compression Using Math - /dev/ttyS0. [ONLINE] Available at: http://www.devttys0.com/2013/06/differentiate-encryption-from-compression-using-math/. [Accessed 31 January 2015].
2. Encryption vs Compression, Part 2 - /dev/ttyS0. 2015. Encryption vs Compression, Part 2 - /dev/ttyS0. [ONLINE] Available at: http://www.devttys0.com/2013/06/encryption-vs-compression-part-2/. [Accessed 31 January 2015].
